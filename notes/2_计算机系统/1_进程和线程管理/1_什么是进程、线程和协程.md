---
title: "多进程和多线程的选择"
layout: post
author: "Marco"
header-style: text
hidden: true
tags:
  - 计算机系统
  - 多线程
---

## 多进程和多线程的选择

> 多进程和多线程都可以作为我们编程时候实现的选择，那什么场合下更适合多线程模式，什么时候更适合多进程模式呢？
>
> 具体一点说就是单线程多进程模式，与单进程多线程模式的优劣之分。

### 1. 基本概念

- ***单线程多进程模式与单进程多线程模式分别是怎么样的？***
  - 单线程多进程
    - 每一个进程一个线程
    - 一个proxy进程用于接收外部请求
    - 多个worker进程
  - 单进程多线程
    - 只有一个进程
    - 一个IO线程，多个worker线程
    - 线程通信通过锁机制、共享内存方式保证通信安全
- ***多线程，多进程分别的优缺点是什么？***
  - 多进程
    - 优点
      - 进程是互相独立的，不涉及锁什么之类的，代码编写方便，调试方便
      - 进程是独立的，所以稳定性更高，一个进程挂了，其他也不会挂；
    - 缺点
      - 进程创建慢，占用内存多，进程的上下文切换代价高昂
      - 进程之间通信麻烦且慢，常用且好的多进程通信机制一般为socket，所以通信内容一般为指令而非数据
  - 多线程
    - 优点
      - 线程创建快，上下文切换快，创建开销小
      - 线程通信快
    - 缺点
      - 要考虑锁机制，代码写起来麻烦
      - 不可靠，一个线程挂了，全挂了

### 2. 补充

- ***多线程、多进程的实际应用场景？***
  - 多进程
    - 自动驾驶操作系统，如Apollo
    - 分布式系统
    - 总的来说，都是非常强调一个进程挂了，不影响其他
  - 多线程
    - 服务器快速响应任务，如果创建进程太耗时了
    - 总的来说，不用多进程的就是多线程的。

- ***linux下线程和进程为什么有人说是一样的？***

  ​	linux的进程本身就很轻量了，线程是当做进程实现的，只是线程创建的时候考虑到共享内存之类的数据问题。但是线程的上下文切换还是要比进程小。

- ***为什么说线程的上下文切换代价要比进程的小？***
  -   ***进程的上下文开销有哪些？***
    - 地址空间的转换，如切换页表全局目录，刷新TLB
    - 硬件上下文切换，如切换内核栈，载入寄存器数据
  - ***线程的上下文开销有哪些***
    - 大体与进程一致，相对线程略小
  - 但是要考虑到CPU Cache命中率，如果是线程的切换，CPU Cache不需要怎么更新，命中率更高。



