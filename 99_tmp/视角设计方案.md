## 视角设计方案

### 0. 设计整体思路

- 视角设计目标

  - BmDbView 支持多个视角信息。

- 简要概述设计实现

  - 从 BmDbView 抽离视角相关信息，新增视角相关 Do，使得 BmDbView 和视角信息不是一一对应。
  - 外部尽可能不感知视角，视角的意义仅仅是因为 BmDbView 可以有多个视角。BmDbView 需要存储这些多个视角，新的 Do 仅是作为 BmDbView 的补充。

- 存在的问题

  1. BmDbView 的视角信息修改的时候，会不会影响其他构件？怎么影响？这些构件需要重生成吗？
     会影响其他构件，目前貌似只影响 BmViewCropRegionViewItem。修改了视角信息之后，需要对这个构件重生成。
     为了解耦，应该是修改的时候能够触发一个 monitor 完成这个重生成过程。

  2. BmDbView 目前仅三维视图需要多份视角，其他视图怎么处理？
     视角信息以一个容器方式存储，所有 BmDbView 都有视角信息，所以实际上是只有三维视图能够添加视角信息而已。
     其他视图不能添加。

  3. 标注与视角是绑定关系。当前视图创建下的注释、标注仅当前视角能看。如何实现这个功能？
     文字构件和标注构件都有类似的要求，两者都要求仅在创建视图下可见。

     文字构件的实现是依赖于 BmDbViewConfigure，shouldCreateCounterpart 的时候判断，是在重生成的过程中解决 visible 问题。而视角是复用了 BmDbView 方法，两者方法不同。

     而标注构件（对齐等等）的实现是依赖于 Editor 创建约束的时候，给标注上了一个 route，然后同样也是在 shouldCreateCounterpart 的过程中解决仅创建视图可见问题。

     对于视角而言，视图是复用的，不完全一样。

  4. 数据存在哪里？需要考虑兼容性
    * 以前没有这个数据，要怎么做兼容

  5. 考虑性能
    * 数据仅仅用于打开时，不会频繁读写

### 1. 具体方案设计

#### 1.1 数据定义

* **原来数据定义**
```
BmDbView::AO{
    MvpMatrix, // ModelViewProjectionMatrix
    BoundBox, // 视图包围盒
    DatumHeight, // 基准高度

    ~V_CoordinateDisplay,  // 是否显示坐标，父类属性
    ~V_viewScale,  // 视图比例
    ~V_displayStyle,  // 视觉样式
    ~V_viewDirty,

}

BmDbView::Route{
    workPlane,
    levelElement,
    annotationCnn,
}
```

* **新的数据定义**
```
BmDbView --route--> {BmDbViewReference}
    route::privateData{
        + ArrAngleOfView, // 视角(Arr<{name, eye, center, up, distance}>)
    }

BmDbView{
private:
    ObjectId m_angularViewInfoRouteId;
}

```

> route参考BmViewConfigurationBase，由BmViewInfoConfigurationBase管理。
> 剥离出来放到BmViewInfoConfigurationBase，是为了减轻BmDbView的负担。
> 考虑到BmDbView可能会有其他新数据，这里使用了继承的方式。

```
BmViewInfoConfiguration::>BmViewInfoConfigurationAngle

+ class BmViewInfoConfigurationBase {
    + open(viewId)      // 读数据
    + close()           // RAII
    + inJson()          
    + outJson()
}

+ class BmViewInfoConfigurationAngle : BmViewInfoConfigurationBase{
public:
    + static SystemStatus getAngularViewDatas(viewId);
    + static SystemStatus getAngularViewDataByName(viewId, angularViewName);
    + static SystemStatus appendAngularViewData(viewId);

    + static SystemStatus removeAngularViewData(viewId, angularViewName){
        ...
        getAffectedEleRefsUnderView(view, angularViewName, elementRefs)
        BmCommOperationDeleteCmd::execute(elementRefs)
    };

private:
    + void notifyAngularViewDataRemove();
    + void notify...
}
```

```
+ class BmDbView {
public:
    + static SystemStatus setAngularViewDataForView(viewId, targetName) {
        curName = getCurAngularViewName(viewId);
        getAffectedEleRefsUnderView(view, curName， hideElementRefs)
        for(eleRef: hideElementRefs){
            BmDbOverrideGraphicsSettingsUtils::setElementRefVisibility(viewId, eleRef, hide);
        }

        getAffectedEleRefsUnderView(view, targetName， showElementRefs)
        for(eleRef: showElementRefs){
            BmDbOverrideGraphicsSettingsUtils::setElementRefVisibility(viewId, eleRef, show);
        }
    }

private:
    + getAffectedEleRefsUnderView(viewId){
        BmDbTextNode::getRefsUnderView(viewId, angularName); // 知道某个视图，某个视角下有哪些Refs
        BmDbDimension::getRefsUnderView(viewId);
        // 通过contextViewId方式实现，view已经和这些eleRef有route的关系了
    }
}
```

#### 1.2 外部接口

- 新增 BmAngularViewCreateCmd
  - AppendAngularViewData
  
- ViewPanel 适配
  - openAngularView
  - deleteAngularView  
  - copyAngularView
    - ...

#### 1.3 业务实现

##### 1.3.1 创建三维视图时，默认有一个视角
```
BmCreateView3DCmd::createView(){
    ...
    // 创建视图后取默认相机参数建立默认视角
    appendAngularViewData
}
```

##### 1.3.2 视图右键功能
* 打开
    openView(){
        setAngularViewData() // 取arr[0]
    }

* 复制
    copyProtocol需要调整，视角也需要被复制。
    无特殊设计，参照已有实现去做。

* 删除
    delete相关联的所有视角。
    无特殊设计，参照已有实现去做。

##### 1.3.3 视角右键功能
* 打开
    ```
    BmViewPanel::call(BmAngularViewOpenCmd);

    BmAngularViewOpenCmd::execute(viewId, angularViewName){
        data = BmViewInfoConfigurationAngle::getAngularViewDataByName(viewId, angularViewName)
        BmDbView::setAngularViewForView(data)
    }
    ```

* 复制
    新增 BmDbAngularViewProtocol
    无特殊设计，参照已有实现去做。

* 重命名
    无特殊设计，参照已有实现去做。

##### 1.3.4 视角数据的恢复
```
BmViewOpenCmd::execute(){
    bool isSuccess = getAngularViewData();
    if(!isSuccess){
        getMvpMatrix();
        writeAngularViewData();
    }

    setGraphicsView(angularViewData)
}
```

##### 1.3.5 视角数据的持久化
每次AngularViewData都修改都会走到setAttribute



1. 编辑已有视角数据