# 项目问题

1. 上锁问题

关于加锁：分为表级锁和页级锁。

GetValue函数：对页进行查询，所以在表级别和页级别都加读锁。

Insert函数：对页进行插入，不涉及表的修改，因此在表级别加读锁，页级别加写锁。

Remove函数：对页进行删除，同Insert一样，在表级别加读锁，在页级别加写锁。

SplitInsert函数：要分裂桶，需要修改整个表，因此表级别加上写锁。

Merge函数：合并空桶，同SplitInsert函数，给表级别加写锁。

2. 不要随意修改代码注释

```cpp
# include<mutex> // NOTLINT
```

NOLINT注释指示clang-tidy忽略同一行上的警告(它不应用于函数、代码块或任何其他语言结构;它适用于它所在的代码行)

3. 解锁和释放页面先后的问题

比较好并且推进的方式是先释放锁，再释放页面。

4. 关于 Merge 的讨论

第一种：根据key找到page，进行桶的合并，观察目录是否进行Shrink，如果Shrink了进行操作：

（1）遍历所有的 bucket，尝试进行合并，如果后续需要桶的分裂，并不友好。如果再次发生shrink跳出，

（2）只看SplitImageBucket是否为空，如果为空进行下次的 merge

>第（2）个方式更为优雅

第二种：直接遍历 global，对于 shrink 后合并 bucket 的情况交付给下一次 Merge来实现，如果后续需要桶的分裂，则无需再次分裂减少开销。