---
title: "多进程和多线程的选择"
layout: post
author: "Marco"
header-style: text
hidden: true
tags:
  - 计算机系统
  - 多线程
---

## 什么是进程/线程和协程

进程:进程是操作系统进行资源分配和调度的基本单位,是应用程序在操作系统中的一次运行过程.进程拥有自己独立的内存空间,每个进程中都有至少一个线程.进程之间的通信需要使用特殊的进程间通信机制.

线程:线程是进程内的执行单元,是操作系统进行调度的基本单位.一个进程中可以包含多个线程,它们共享进程的内存空间,因此线程间的通信更为方便.但是,多线程编程需要处理好同步和互斥,以避免数据竞争和死锁等问题.

协程:协程(Coroutine)是一种用户态的轻量级线程,协程的调度完全由用户控制.协程有点类似于线程,但协程避免了无意义的调度,而且提供了方便的协作式多任务处理能力.协程在某些场景下,如IO密集型任务,可以提高程序的执行效率.

### 1. 基本概念

- ***单线程多进程模式与单进程多线程模式分别是怎么样的？***
  - 单线程多进程
    每个进程只有一个线程.这种模式的优点是进程间互相独立,一个进程的崩溃不会影响其他进程,稳定性较高.缺点是进程创建和销毁的开销较大,进程间通信复杂,通常需要使用IPC(进程间通信)机制,如管道/消息队列/共享内存等.
  - 单进程多线程
    一个进程内有多个线程.这种模式的优点是线程间共享内存,通信简单,线程创建和销毁的开销较小.缺点是线程间共享状态,需要处理并发控制问题(如数据竞态/死锁等),并且一个线程的崩溃可能会导致整个进程崩溃.
  - 多线程多进程
    每个进程有多个线程.这种模式结合了前两种模式的优点,可以实现更复杂的并发模型,如生产者-消费者模型/读者-写者模型等.但同时,这种模式也继承了前两种模式的缺点,如需要处理并发控制问题,进程间通信复杂,进程和线程的创建和销毁开销较大等.
- ***多线程，多进程分别的优缺点是什么？***
  - 多进程
    - 优点
      - 进程是互相独立的，不涉及锁什么之类的，代码编写方便，调试方便
      - 进程是独立的，所以稳定性更高，一个进程挂了，其他也不会挂；
    - 缺点
      - 进程创建慢，占用内存多，进程的上下文切换代价高昂
      - 进程之间通信麻烦且慢，常用且好的多进程通信机制一般为socket，所以通信内容一般为指令而非数据
  - 多线程
    - 优点
      - 线程创建快，上下文切换快，创建开销小
      - 线程通信快
    - 缺点
      - 要考虑锁机制，代码写起来麻烦
      - 不可靠，一个线程挂了，全挂了

### 2. 补充

#### 2.1 
进程/线程和协程的搭配使用主要取决于你的应用程序的需求和特性.

- **多进程**:如果你的应用程序需要进行大量的计算并且可以并行执行,那么多进程可能是一个好选择.每个进程都有自己的内存空间,所以它们可以在不同的CPU核心上并行执行,从而提高总体的计算速度.此外,如果一个进程崩溃,它不会影响其他的进程.

- **多线程**:如果你的应用程序需要共享大量的内存数据,那么多线程可能是一个好选择.线程共享同一个进程的内存空间,所以它们可以直接访问相同的变量和数据结构,而不需要复杂的进程间通信.然而,多线程编程需要小心处理同步和互斥,以避免数据竞争和死锁.

- **协程**:如果你的应用程序需要处理大量的IO操作,如网络请求或文件读写,那么协程可能是一个好选择.协程可以在IO操作等待期间让出CPU,从而允许其他协程继续执行.这可以提高程序的响应性和吞吐量.

在实际的应用程序中,你可能会结合使用这三种技术.例如,你可能会创建多个进程,每个进程中有多个线程,每个线程中又运行多个协程.这样的模型可以充分利用多核CPU,并有效地处理IO密集型任务.

- ***多线程、多进程的实际应用场景？***
  - 多进程
    - 分布式系统
    - 总的来说，都是非常强调一个进程挂了，不影响其他
  - 多线程
    - 服务器快速响应任务，如果创建进程太耗时了
    - 总的来说，不用多进程的就是多线程的。

- ***linux下线程和进程为什么有人说是一样的？***

  ​	linux的进程本身就很轻量了，线程是当做进程实现的，只是线程创建的时候考虑到共享内存之类的数据问题。但是线程的上下文切换还是要比进程小。

- ***为什么说线程的上下文切换代价要比进程的小？***
  -   ***进程的上下文开销有哪些？***
    - 地址空间的转换，如切换页表全局目录，刷新TLB
    - 硬件上下文切换，如切换内核栈，载入寄存器数据
  - ***线程的上下文开销有哪些***
    - 大体与进程一致，相对线程略小
  - 但是要考虑到CPU Cache命中率，如果是线程的切换，CPU Cache不需要怎么更新，命中率更高。

