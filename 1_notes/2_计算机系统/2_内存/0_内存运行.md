## 内存运行的基本原理


- 内存工作原理

  - 内存中的cell按矩阵形排列，每一行和每一列都会有一个对应的行地址线路（正规叫法叫做word line）和列地址线路（正规叫法是bit line），每个具体的cell就挂接在这样的行地址线路和列地址线路上，对应一个唯一的行号和列号，把行号和列号组合在一起，就是内存的地址。

  - [video-内存的工作原理-内存是怎么存数据的？](https://www.youtube.com/watch?v=aO_kBa9DzPQ)

    > 内存是以页为单位进行存储的

  - [linux内存页大小](https://blog.csdn.net/qq_35995514/article/details/113060907)


### 1. 内存的作用

- **为什么要有内存？**

  CPU 的处理速度远远快于磁盘，内存的主要作用是缓解 CPU 与硬盘之间的速度矛盾。如果没有内存，CPU 将不得不等待磁盘传输数据，这会浪费 CPU 的性能。

- **为什么内存比硬盘快？**

  内存的速度之所以比硬盘快，是因为它们的存储原理和读取方式不同。硬盘是机械结构，通过磁头的转动读取数据，而内存是通过电存取数据的。

- **程序的准备**：

  1. **编写源代码**：

     - 开发者使用编程语言编写源代码，并将其保存在硬盘上。

  2. **编译**：

     - 由编译程序将用户源代码编译成若干个目标模块。目标模块是机器码文件，通常保存在硬盘上。
     - **涉及内容**：词法分析、语法分析、语义分析、中间代码生成、代码优化、目标代码生成

  3. **链接**：

     - 由链接程序将编译后形成的目标模块和所需库函数链接在一起，形成一个完整的装入模块。装入模块也是机器码文件，保存在硬盘上。
     - **涉及内容**：静态链接、装入时动态链接、运行时动态链接

- **程序的运行**：

  1. **装入**：

     - 由装入程序将装入模块从硬盘装入内存。装入程序会将装入模块的内容复制到内存的某个位置，并准备好程序运行所需的环境。
     - **涉及内容**：绝对装入、静态装入、动态装入

  2. **取指**：

     - PC 保存了下一条要执行的指令的内存地址。在正常顺序执行时，PC 的值会自动递增，指向下一条指令的地址。
     - 在分支和跳转指令执行时，PC 的值会被修改为目标指令的地址，从而实现程序的流程控制，如条件分支、循环、函数调用和返回等。

  3. **译码**：

     - CPU 的控制单元根据指令的操作码部分，识别出指令的类型（如数据传输、算术运算、逻辑运算、控制流等）和操作数的寻址方式。
     - 对于不同的指令类型，控制单元会设置相应的控制信号，将操作数发送到相应的运算单元（如算术逻辑单元 ALU）或存储单元（如寄存器、内存）。
     - 对于复杂指令集（CISC）处理器，一条指令可能包含多个微操作，译码过程会将一条指令拆分为多个微操作，以提高处理器的性能；对于精简指令集（RISC）处理器，指令相对简单，译码过程相对简洁。

  4. **执行**：

     - 对于加法、减法、乘法、除法等算术运算，CPU 的 ALU 根据操作数和操作码进行计算。操作数可以来自寄存器或内存，计算结果可以存储在寄存器或写回内存。
     - 现代处理器通常具有多个执行单元，可以同时执行多个算术运算，提高并行处理能力。
     - **逻辑运算**：
       - 包括与、或、非、异或等逻辑运算，用于处理逻辑判断和位操作。逻辑运算在控制流、数据处理和错误检测等方面有广泛应用。
     - **内存访问**：
       - 对于内存访问指令，CPU 需要将逻辑地址转换为物理地址。这涉及到地址转换机制，通常由内存管理单元（MMU）完成。
       - **地址转换过程**：
         - **逻辑地址和物理地址**：逻辑地址是程序使用的地址，不考虑实际的物理内存布局；物理地址是内存中实际的存储位置。
         - **分页系统中的地址转换**：在分页系统中，逻辑地址分为页号和页内偏移量。MMU 通过查找页表将页号转换为页框号（物理页号），再结合页内偏移量得到物理地址。页表存储在内存中，通常由操作系统管理，为了提高性能，可能使用快表（TLB）作为页表的高速缓存，加快地址转换速度。
         - **分段系统中的地址转换**：在分段系统中，逻辑地址分为段号和段内地址。MMU 通过查找段表将段号转换为段的基地址，再加上段内地址得到物理地址。段表包含段的基地址、段限长等信息，用于段的保护和越界检查。
         - **段页式系统中的地址转换**：结合了分段和分页的优点，逻辑地址先通过段表找到段的页表，再通过页表找到页框号，最终得到物理地址。

  5. **写回**：

     - **结果的存储位置**：
       - 如果指令执行的结果需要保存，根据指令的语义，结果可以存储在寄存器或内存中。
       - 对于存储在内存中的结果，CPU 会将结果通过数据总线发送到内存，由内存控制器将数据写入相应的物理地址。
       - 对于存储在寄存器中的结果，将用于后续的指令操作，以提高数据的访问速度。

### 2. 操作系统需要为内存提供什么能力？

- **程序的本质**：

  - 程序是指挥计算机运行和操作的一系列指令的集合，它包含命令段（指令序列）和数据段（存储程序运行所需的数据）。这些命令和数据本质上都是存储在存储介质中的信息。
  - 程序中的命令段负责完成各种操作，如算术运算、逻辑判断、流程控制等，而数据段存储着程序运行过程中需要使用的变量、常量、数组等数据。

- **存储介质差异**：

  - 硬盘和内存作为不同的存储介质，具有显著差异。硬盘是基于磁性或固态存储技术，具有大容量但读写速度慢，适合长期存储大量数据；而内存是基于半导体存储技术，读写速度快，但容量相对较小且断电后数据丢失。
  - 它们之间可以看作是一种存储容量、价格和 I/O 速度的权衡。硬盘的存储成本低但速度慢，适合存储不常访问的数据，而内存速度快但成本高，用于存储当前正在运行程序所需的指令和数据。

- **小结**

  - 程序的本质上是存储介质的信息，是指挥计算机运行和操作的一系列指令的集合；
  - 内存存在的意义是因为 cpu 速度和硬盘（存储介质）的速度不匹配；
  - 内存的存储对象就是程序；

  - 操作系统需要为内存提供这些机制：
    - 内存的装入和链接：
      - 程序从硬盘到内存的过程，其中装入包括绝对装入（编译时已知程序在内存中的位置，按绝对地址装入）、可重定位装入（将逻辑地址在装入时转换为物理地址）、动态装入（将逻辑地址的转换推迟到程序执行时）等；链接包括静态链接（在程序运行前完成所有链接）、动态链接（包括装入时动态链接和运行时动态链接）等。
    - 内存分配与管理：
      - 内存如何分配、回收，包括连续分配（如单一连续分配，将内存分为系统区和用户区，仅适用于单用户/单任务系统；固定分区分配，将用户空间划分为固定大小的分区；动态分区分配，根据进程大小动态建立分区）和非连续分配（如分页，将内存和进程空间划分为相等的页和页框；分段，将地址空间按程序逻辑关系划分为段；段页式，结合分段和分页）等。
    - 高级功能与优化：
      - 虚拟内存：通过将磁盘空间作为物理内存的扩展，为程序提供比实际物理内存更大的虚拟地址空间，解决物理内存不足的问题。
      - 内存保护：防止进程之间以及进程与操作系统之间的非法内存访问，确保系统的稳定性和安全性，通常通过硬件和软件结合实现。
      - 高速缓存管理：利用高速缓存（Cache）来提高内存访问速度，减少 CPU 等待时间，包括多级缓存结构（如 L1、L2、L3 缓存）和缓存替换策略（如 LRU、FIFO 等）。
      - 内存碎片整理：解决内存中出现的碎片问题，提高内存的利用率，包括内部碎片（如分页时页内未使用部分）和外部碎片（如动态分区分配产生的小空闲分区），可采用紧凑技术等。
      - 共享内存：允许多个进程共享部分内存，以实现进程间的数据共享和通信，提高系统资源的利用率。
      - 内存映射：将文件映射到内存，提高文件的访问效率，可用于大文件操作和进程间通信等。
