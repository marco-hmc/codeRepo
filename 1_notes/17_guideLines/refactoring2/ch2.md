# 第 2 章 重构的原则

## 2.5 重构的挑战

### 分支

我们采用的方法叫作持续集成(Continuous Integration,CI),也叫"基于主干开发"(Trunk-Based Development).在使用 CI 时,每个团队成员每天至少向主线集成一次.这个实践避免了任何分支彼此差异太大,从而极大地降低了合并的难度.不过 CI 也有其代价:你必须使用相关的实践以确保主线随时处于健康状态,必须学会将大功能拆分成小块,还必须使用特性开关(feature toggle,也叫特性旗标,feature flag)将尚未完成又无法拆小的功能隐藏掉.

### 遗留代码

这个问题没有简单的解决办法,我能给出的最好建议就是买一本<修改代码的艺术>[Feathers],照书里的指导来做.别担心那本书太老,尽管已经出版十多年,其中的建议仍然管用.一言以蔽之,它建议你先找到程序的接缝,在接缝处插入测试,如此将系统置于测试覆盖之下.你需要运用重构手法创造出接缝__这样的重构很危险,因为没有测试覆盖,但这是为了取得进展必要的风险.在这种情况下,安全的自动化重构简直就是天赐福音.如果这一切听起来很困难,因为它确实很困难.很遗憾,一旦跌进这个深坑,没有爬出来的捷径,这也是我强烈倡导从一开始就写能自测试的代码的原因.

### 数据库

在本书的第 1 版中,我说过数据库是"重构经常出问题的一个领域".然而在第 1 版问世之后仅仅一年,情况就发生了改变:
我的同事 Pramod Sadalage 发展出一套渐进式数据库设计[mf-evodb]和数据库重构[Ambler &amp; Sadalage]的办法,如今已经被广泛使用.这项技术的精要在于:借助数据迁移脚本,将数据库结构的修改与代码相结合,使大规模的/涉及数据库的修改可以比较容易地开展.

假设我们要对一个数据库字段(列)改名.和改变函数声明(124)一样,我要找出结构的声明处和所有调用处,然后一次完成所有修改.但这里的复杂之处在于,原来基于旧字段的数据,也要转为使用新字段.我会写一小段代码来执行数据转化的逻辑,并把这段代码放进版本控制,跟数据结构声明与使用代码的修改一并提交.此后如果我想把数据库迁移到某个版本,只要执行当前数据库版本与目标版本之间的所有迁移脚本即可.

跟通常的重构一样,数据库重构的关键也是小步修改并且每次修改都应该完整,这样每次迁移之后系统仍然能运行.由于每次迁移涉及的修改都很小,写起来应该容易;将多个迁移串联起来,就能对数据库结构及其中存储的数据做很大的调整.

与常规的重构不同,很多时候,数据库重构最好是分散到多次生产发布来完成,这样即便某次修改在生产数据库上造成了问题,也比较容易回滚.比如,要改名一个字段,我的第一次提交会新添一个字段,但暂时不使用它.然后我会修改数据写入的逻辑,使其同时写入新旧两个字段.随后我就可以修改读取数据的地方,将它们逐个改为使用新字段.这步修改完成之后,我会暂停一小段时间,看看是否有 bug 冒出来.确定没有 bug 之后,我再删除已经没人使用的旧字段.这种修改数据库的方式是并行修改(Parallel Change,也叫扩展协议/expand-contract)[mf-pc]的一个实例.

## 2.6 重构/架构和 YAGNI

重构极大地改变了人们考虑软件架构的方式.在我的职业生涯早期,我被告知:在任何人开始写代码之前,必须先完成软件的设计和架构.一旦代码写出来,架构就固定了,只会因为程序员的草率对待而逐渐腐败.

这种设计方法有很多名字:简单设计/增量式设计或者 YAGNI[mf-yagni]__"你不会需要它"(you arenʼt going to need it)的缩写.YAGNI 并不是"不做架构性思考"的意思,不过确实有人以这种欠考虑的方式做事.我把 YAGNI 视为将架构/设计与开发过程融合的一种工作方式,这种工作方式必须有重构作为基础才可靠.

采用 YAGNI 并不表示完全不用预先考虑架构.总有一些时候,如果缺少预先的思考,重构会难以开展.但两者之间的平衡点已经发生了很大的改变:如今我更倾向于等一等,待到对问题理解更充分,再来着手解决.演进式架构[Ford et al.]是一门仍在不断发展的学科,架构师们在不断探索有用的模式和实践,充分发挥迭代式架构决策的能力.

## 2.7 重构与软件开发过程

读完前面"重构的挑战"一节,你大概已经有这个印象:重构是否有效,与团队采用的其他软件开发实践紧密相关.重构起初是作为极限编程(XP)[mf-xp]的一部分被人们采用的,XP 本身就融合了一组不太常见而又彼此关联的实践,例如持续集成/自测试代码以及重构(后两者融汇成了测试驱动开发).

极限编程是最早的敏捷软件开发方法[mf-nm]之一.在一段历史时期,极限编程引领了敏捷的崛起.如今已经有很多项目使用敏捷方法,甚至敏捷的思维已经被视为主流,但实际上大部分"敏捷"项目只是徒有其名.要真正以敏捷的方式运作项目,团队成员必须在重构上有能力/有热情,他们采用的开发过程必须与常规的/持续的重构相匹配.

有这三大实践在手,我们就能运用前一节介绍的 YAGNI 设计方法.重构和 YAGNI 交相呼应/彼此增效,重构(及其前置实践)是 YAGNI 的基础,YAGNI 又让重构更易于开展:比起一个塞满了想当然的灵活性的系统,当然是修改一个简单的系统要容易得多.在这些实践之间找到合适的平衡点,你就能进入良性循环,你的代码既牢固可靠又能快速响应变化的需求.

有这三大核心实践打下的基础,才谈得上运用敏捷思想的其他部分.持续交付确保软件始终处于可发布的状态,很多互联网团队能做到一天多次发布,靠的正是持续交付的威力.即便我们不需要如此频繁的发布,持续集成也能帮我们降低风险,并使我们做到根据业务需要随时安排发布,而不受技术的局限.有了可靠的技术根基,我们能够极大地压缩"从好点子到生产代码"的周期时间,从而更好地服务客户.这些技术实践也会增加软件的可靠性,减少耗费在 bug 上的时间.
