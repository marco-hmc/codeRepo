# 数据库和数据库管理系统（DBMS）

## 什么是数据库？

数据库是一个有组织的结构化信息或数据的集合，通常以电子方式存储在计算机系统中。数据库通常由数据库管理系统（DBMS）控制。数据和 DBMS 以及与它们相关的应用程序一起被称为数据库系统，通常简称为数据库。

## 什么是 DBMS？

数据库通常需要一个全面的数据库软件程序，称为数据库管理系统（DBMS）。DBMS 作为数据库与其终端用户或程序之间的接口，允许用户检索、更新和管理信息的组织和优化方式。DBMS 还促进对数据库的监督和控制，支持各种管理操作，如性能监控、调优和备份与恢复。

## 组件

以下是不同数据库中常见的一些组件：

### 模式

模式的作用是定义数据结构的形状，并指定哪些类型的数据可以放在哪里。模式可以在整个数据库中严格执行，也可以在部分数据库中松散执行，或者根本不存在。

### 表

每个表包含各种列，就像电子表格一样。表可以只有两列，也可以有多达一百列或更多列，具体取决于表中存放的信息类型。

### 列

列包含特定类型的数据值集合，每行一个值。列可以包含文本值、数字、枚举、时间戳等。

### 行

表中的数据以行记录。表中可以有成千上万甚至数百万行记录特定信息。

## 类型

![数据库类型](https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-II/databases-and-dbms/database-types.png)

以下是不同类型的数据库：

- **[SQL](https://karanpratapsingh.com/courses/system-design/sql-databases)**
- **[NoSQL](https://karanpratapsingh.com/courses/system-design/nosql-databases)**
  - 文档型
  - 键值型
  - 图形型
  - 时间序列型
  - 宽列型
  - 多模型

SQL 和 NoSQL 数据库是广泛的话题，将在 [SQL 数据库](https://karanpratapsingh.com/courses/system-design/sql-databases) 和 [NoSQL 数据库](https://karanpratapsingh.com/courses/system-design/nosql-databases) 中分别讨论。了解它们之间的比较，请参见 [SQL vs NoSQL 数据库](https://karanpratapsingh.com/courses/system-design/sql-vs-nosql-databases)。

## 挑战

在大规模运行数据库时面临的一些常见挑战：

- **吸收显著增加的数据量**：来自传感器、连接设备和其他来源的数据爆炸性增长。
- **确保数据安全**：如今数据泄露无处不在，确保数据安全但也易于用户访问比以往任何时候都更重要。
- **跟上需求**：公司需要实时访问数据以支持及时决策并抓住新机会。
- **管理和维护数据库和基础设施**：随着数据库变得越来越复杂，数据量不断增长，公司面临着雇佣额外人才来管理数据库的费用。
- **消除扩展限制**：如果企业要生存，就需要增长，其数据管理也必须随之增长。但很难预测公司需要多少容量，特别是对于本地数据库。
- **确保数据驻留、数据主权或延迟要求**：某些组织有更适合在本地运行的用例。在这些情况下，预配置和预优化的工程系统是理想的选择。

# SQL 数据库

SQL（或关系型）数据库是具有预定义关系的数据项集合。这些项被组织为具有列和行的表。表用于保存要在数据库中表示的对象的信息。表中的每一列保存某种类型的数据，字段存储属性的实际值。表中的行表示一个对象或实体的相关值集合。

表中的每一行可以用一个称为主键的唯一标识符标记，多个表之间的行可以使用外键关联。这些数据可以通过多种方式访问，而无需重新组织数据库表。SQL 数据库通常遵循 [ACID 一致性模型](https://karanpratapsingh.com/courses/system-design/acid-and-base-consistency-models#acid)。

## 物化视图

物化视图是从查询规范派生并存储以供以后使用的预计算数据集。由于数据是预计算的，查询物化视图比执行对视图基表的查询更快。当查询频繁运行或足够复杂时，这种性能差异可能非常显著。

它还支持数据子集化，并提高在大数据集上运行的复杂查询的性能，从而减少网络负载。物化视图还有其他用途，但它们主要用于性能和复制。

## N+1 查询问题

N+1 查询问题发生在数据访问层执行 N 个额外的 SQL 语句以获取可以通过执行主 SQL 查询检索到的相同数据时。N 的值越大，执行的查询越多，性能影响越大。

这在 GraphQL 和 ORM（对象关系映射）工具中很常见，可以通过优化 SQL 查询或使用批量连续请求并在底层进行单次数据请求的数据加载器来解决。

## 优点

让我们看看使用关系数据库的一些优点：

- 简单且准确
- 可访问性
- 数据一致性
- 灵活性

## 缺点

以下是关系数据库的缺点：

- 维护成本高
- 模式演变困难
- 性能影响（连接、反规范化等）
- 由于水平扩展性差，难以扩展

## 示例

以下是一些常用的关系数据库：

- [PostgreSQL](https://www.postgresql.org)
- [MySQL](https://www.mysql.com)
- [MariaDB](https://mariadb.org)
- [Amazon Aurora](https://aws.amazon.com/rds/aurora)

# NoSQL 数据库

NoSQL 是一个广泛的类别，包括任何不使用 SQL 作为主要数据访问语言的数据库。这些类型的数据库有时也被称为非关系型数据库。与关系数据库不同，NoSQL 数据库中的数据不必符合预定义的模式。NoSQL 数据库遵循 [BASE 一致性模型](https://karanpratapsingh.com/courses/system-design/acid-and-base-consistency-models#base)。

以下是不同类型的 NoSQL 数据库：

### 文档型

文档数据库（也称为文档导向数据库或文档存储）是一种以文档形式存储信息的数据库。它们是通用数据库，服务于各种事务性和分析性应用。

**优点**

- 直观且灵活
- 易于水平扩展
- 无模式

**缺点**

- 无模式
- 非关系型

**示例**

- [MongoDB](https://www.mongodb.com)
- [Amazon DocumentDB](https://aws.amazon.com/documentdb)
- [CouchDB](https://couchdb.apache.org)

### 键值型

键值数据库是最简单的 NoSQL 数据库类型之一，以键值对的形式保存数据，每对由两个数据项组成。它们有时也被称为键值存储。

**优点**

- 简单且高效
- 高度可扩展，适用于高流量
- 会话管理
- 优化查找

**缺点**

- 基本的 CRUD 操作
- 无法过滤值
- 缺乏索引和扫描功能
- 不适合复杂查询

**示例**

- [Redis](https://redis.io)
- [Memcached](https://memcached.org)
- [Amazon DynamoDB](https://aws.amazon.com/dynamodb)
- [Aerospike](https://aerospike.com)

### 图形型

图形数据库是一种 NoSQL 数据库，使用图结构进行语义查询，使用节点、边和属性来表示和存储数据，而不是表或文档。

图形数据库将存储中的数据项与节点和边的集合相关联，边表示节点之间的关系。这些关系允许存储中的数据直接链接在一起，并且在许多情况下可以通过一次操作检索。

**优点**

- 查询速度快
- 敏捷且灵活
- 明确的数据表示

**缺点**

- 复杂
- 没有标准化的查询语言

**用例**

- 欺诈检测
- 推荐引擎
- 社交网络
- 网络映射

**示例**

- [Neo4j](https://neo4j.com)
- [ArangoDB](https://www.arangodb.com)
- [Amazon Neptune](https://aws.amazon.com/neptune)
- [JanusGraph](https://janusgraph.org)

### 时间序列型

时间序列数据库是一种针对时间戳或时间序列数据进行优化的数据库。

**优点**

- 快速插入和检索
- 高效的数据存储

**用例**

- 物联网数据
- 指标分析
- 应用监控
- 理解金融趋势

**示例**

- [InfluxDB](https://www.influxdata.com)
- [Apache Druid](https://druid.apache.org)

### 宽列型

宽列数据库，也称为宽列存储，是无模式的。数据存储在列族中，而不是行和列中。

**优点**

- 高度可扩展，可以处理 PB 级数据
- 适用于实时大数据应用

**缺点**

- 昂贵
- 写入时间增加

**用例**

- 商业分析
- 基于属性的数据存储

**示例**

- [BigTable](https://cloud.google.com/bigtable)
- [Apache Cassandra](https://cassandra.apache.org)
- [ScyllaDB](https://www.scylladb.com)

### 多模型

多模型数据库将不同的数据库模型（如关系型、图形、键值、文档等）结合到一个单一的集成后端中。这意味着它们可以容纳各种数据类型、索引、查询，并以多种模型存储数据。

**优点**

- 灵活性
- 适用于复杂项目
- 数据一致

**缺点**

- 复杂
- 不够成熟

**示例**

- [ArangoDB](https://www.arangodb.com)
- [Azure Cosmos DB](https://azure.microsoft.com/en-in/services/cosmos-db)
- [Couchbase](https://www.couchbase.com)

# SQL vs NoSQL 数据库

在数据库的世界中，有两种主要类型的解决方案：SQL（关系型）和 NoSQL（非关系型）数据库。它们在构建方式、存储的信息类型以及存储方式上有所不同。关系数据库是结构化的，具有预定义的模式，而非关系数据库是非结构化的、分布式的，具有动态模式。

## 高层次的区别

以下是 SQL 和 NoSQL 之间的一些高层次区别：

### 存储

SQL 将数据存储在表中，每行代表一个实体，每列代表该实体的一个数据点。

NoSQL 数据库有不同的数据存储模型，如键值、图形、文档等。

### 模式

在 SQL 中，每条记录符合固定的模式，这意味着在数据输入之前必须决定和选择列，并且每行必须有每列的数据。模式可以稍后更改，但需要通过迁移修改数据库。

而在 NoSQL 中，模式是动态的。可以随时添加字段，并且每个记录（或等效物）不必包含每个字段的数据。

### 查询

SQL 数据库使用 SQL（结构化查询语言）来定义和操作数据，非常强大。

在 NoSQL 数据库中，查询集中在文档集合上。不同的数据库有不同的查询语法。

### 可扩展性

在大多数常见情况下，SQL 数据库是垂直可扩展的，这可能非常昂贵。可以将关系数据库扩展到多个服务器，但这是一个具有挑战性且耗时的过程。

另一方面，NoSQL 数据库是水平可扩展的，这意味着我们可以轻松地向 NoSQL 数据库基础设施中添加更多服务器以处理大量流量。任何廉价的商品硬件或云实例都可以托管 NoSQL 数据库，因此比垂直扩展更具成本效益。许多 NoSQL 技术还会自动将数据分布到服务器上。

### 可靠性

绝大多数关系数据库符合 ACID 标准。因此，当涉及数据可靠性和执行事务的安全保证时，SQL 数据库仍然是更好的选择。

大多数 NoSQL 解决方案为了性能和可扩展性而牺牲了 ACID 合规性。

## 原因

我们应该始终选择更符合需求的技术。让我们看看选择 SQL 或 NoSQL 数据库的一些原因：

**选择 SQL 的原因**

- 结构化数据，具有严格的模式
- 关系数据
- 需要复杂的连接
- 事务
- 按索引查找非常快

**选择 NoSQL 的原因**

- 动态或灵活的模式
- 非关系数据
- 不需要复杂的连接
- 非常数据密集的工作负载
- 非常高的 IOPS 吞吐量

# 数据库复制

复制是一个涉及共享信息以确保冗余资源（如多个数据库）之间一致性的过程，以提高可靠性、容错性或可访问性。

## 主从复制

主服务器处理读写操作，将写操作复制到一个或多个从服务器，从服务器仅处理读操作。从服务器还可以以树状结构复制其他从服务器。如果主服务器离线，系统可以继续以只读模式运行，直到从服务器提升为主服务器或配置新的主服务器。

![主从复制](https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-II/database-replication/master-slave-replication.png)

### 优点

- 对整个数据库进行备份，对主服务器几乎没有影响。
- 应用程序可以从从服务器读取，而不会影响主服务器。
- 从服务器可以离线并同步回主服务器，而不会有任何停机时间。

### 缺点

- 复制增加了更多的硬件和额外的复杂性。
- 主服务器故障时的停机时间和可能的数据丢失。
- 在主从架构中，所有写操作也必须在主服务器上进行。
- 读从服务器越多，我们需要复制的越多，这将增加复制延迟。

## 主主复制

两个主服务器都处理读写操作，并相互协调。如果其中一个主服务器宕机，系统可以继续处理读写操作。

![主主复制](https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-II/database-replication/master-master-replication.png)

### 优点

- 应用程序可以从两个主服务器读取。
- 将写负载分布在两个主节点上。
- 简单、自动和快速的故障切换。

### 缺点

- 配置和部署不如主从简单。
- 要么松散一致，要么由于同步而增加写延迟。
- 随着写节点的增加和延迟的增加，冲突解决变得更加重要。

## 同步 vs 异步复制

同步复制和异步复制的主要区别在于数据写入副本的方式。在同步复制中，数据同时写入主存储和副本。因此，主副本和副本应该始终保持同步。

相比之下，异步复制在数据已经写入主存储后将数据复制到副本。尽管复制过程可能接近实时发生，但更常见的是复制按计划进行，并且更具成本效益。

# 索引

当涉及数据库时，索引是众所周知的，它们用于提高数据存储上的数据检索操作的速度。索引通过增加存储开销和减慢写入速度（因为我们不仅要写入数据，还要更新索引）来换取更快的读取速度。索引用于快速定位数据，而无需检查数据库表中的每一行。索引可以使用数据库表的一列或多列创建，为快速随机查找和有序记录的高效访问提供基础。

![索引](https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-II/indexes/indexes.png)

索引是一种数据结构，可以看作是指向实际数据位置的目录。因此，当我们在表的一列上创建索引时，我们在索引中存储该列和指向整行的指针。索引还用于创建相同数据的不同视图。对于大数据集，这是指定不同过滤器或排序方案的绝佳方式，而无需创建多个数据副本。

数据库索引的一个特性是它们可以是**密集**的或**稀疏**的。每种索引类型都有其自身的权衡。让我们看看每种索引类型的工作原理：

## 密集索引

在密集索引中，为表的每一行创建一个索引记录。记录可以直接定位，因为索引的每条记录都包含搜索键值和指向实际记录的指针。

![密集索引](https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-II/indexes/dense-index.png)

密集索引在写入时比稀疏索引需要更多的维护。由于每行必须有一个条目，数据库必须在插入、更新和删除时维护索引。每行都有一个条目也意味着密集索引需要更多的内存。密集索引的好处是可以通过二分搜索快速找到值。密集索引也不对数据施加任何排序要求。

## 稀疏索引

在稀疏索引中，仅为部分记录创建索引记录。

![稀疏索引](https://raw.githubusercontent.com/karanpratapsingh/portfolio/master/public/static/courses/system-design/chapter-II/indexes/sparse-index.png)

稀疏索引在写入时比密集索引需要更少的维护，因为它们只包含值的子集。这种较轻的维护负担意味着插入、更新和删除会更快

稀疏索引在写入时比密集索引需要更少的维护，因为它们只包含值的一个子集。这种较轻的维护负担意味着插入、更新和删除操作会更快。较少的条目也意味着索引将使用更少的内存。由于通常在二分搜索之后需要跨页面扫描，因此查找数据的速度较慢。当处理有序数据时，稀疏索引也是可选的。