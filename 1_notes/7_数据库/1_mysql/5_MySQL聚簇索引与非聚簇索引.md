---
title: "MySQL聚簇索引与非聚簇索引"
layout: post
author: "Marco"
header-style: text
hidden: true
tags:
  - 数据库
---

## MySQL聚簇索引与非聚簇索引

### 1. 基本概念

- ***什么是聚簇索引和非聚簇索引？***

  - 聚簇索引：将数据存储与索引放到了一块，找到索引也就找到了数据。InnoDB引擎使用的是聚簇索引。

    ![image-20220328125910396](https://s2.loli.net/2022/03/28/lx3rnUkS4OTP6Ga.png)

  - 非聚簇索引：将数据存储于索引分开结构，索引结构的叶子节点指向了数据的对应行，myisam通过key_buffer把索引先缓存到内存中，当需要访问数据时（通过索引访问数据），在内存中直接搜索索引，然后通过索引找到磁盘相应数据，这也就是为什么索引不在key buffer命中时，速度慢的原因。MyISM使用的是非聚簇索引。

    ![image-20220328125821424](https://s2.loli.net/2022/03/28/Tu4e8HdEabpCrmF.png)

### 2. 进阶概念

- ***聚簇索引的优势与劣势？***
- 优势
    1. 由于**行数据和叶子节点存储在一起，同一页中会有多条行数据，访问同一数据页不同行记录时，已经把页加载到了Buffer中，再次访问的时候，会在内存中完成访问**，不必访问磁盘。这样**主键和行数据是一起被载入内存的，找到叶子节点就可以立刻将行数据返回**了，**如果按照主键Id来组织数据，获得数据更快**。
    2. **辅助索引使用主键作为"指针"而不是使用地址值作为指针的好处**是，**减少了当出现行移动或者数据页分裂时辅助索引的维护工作**，**使用主键值当作指针会让辅助索引占用更多的空间，换来的好处是InnoDB在移动行时无须更新辅助索引中的这个"指针"**。**也就是说行的位置（实现中通过16K的Page来定位）会随着**[**数据库**](https://cloud.tencent.com/solution/database?from=10680)**里数据的修改而发生变化（前面的B+树节点分裂以及Page的分裂），使用聚簇索引就可以保证不管这个主键B+树的节点如何变化，辅助索引树都不受影响**。
    3. 聚簇索引适合用在排序的场合，非聚簇索引不适合
    4. 取出一定范围数据的时候，使用用聚簇索引
    5. 二级索引需要两次索引查找，而不是一次才能取到数据，因为存储引擎第一次需要通过二级索引找到索引的叶子节点，从而找到数据的主键，然后在聚簇索引中用主键再次查找索引，再找到数据
    6. 可以把**相关数据保存在一起**。例如实现电子邮箱时，可以根据用户 ID 来聚集数据，这样只需要从磁盘读取少数的数据页就能获取某个用户的全部邮件。如果没有使用聚簇索引，则每封邮件都可能导致一次磁盘 I/O。
  - 劣势
    1. **维护索引很昂贵，特别是插入新行或者主键被更新导至要分页(page split)的时候**。建议在大量插入新行后，选在负载较低的时间段，通过OPTIMIZE TABLE优化表，因为必须被移动的行数据可能造成碎片。使用独享表空间可以弱化碎片
    2. 表因为使用UUId（随机ID）作为主键，使数据存储稀疏，这就会出现聚簇索引有可能有比全表扫面更慢，

-  ***聚簇索引的优势与劣势？***

  - 优点
    * 非聚簇叶子节点数据部分只存储了聚簇索引键值，而不是行指针(row pointers)，这减小了移动数据或者数据页面分裂时维护非聚簇索引的开销，因为**不需要更新索引的行指针**
  - 缺点
    * 非聚簇索引的二次查询（回表）问题：**二级索引访问需要两次索引查找，第一次找到主键值，第二次根据主键值找到行数据**

  