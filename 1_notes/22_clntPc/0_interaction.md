## 客户端程序

### 1. 无命令交互

在客户端程序中，无命令交互指的是用户与软件界面之间的交互方式，这些交互方式不依赖于传统的命令行输入或菜单选择。无命令交互通常依赖于图形用户界面（GUI）元素，允许用户通过直观的操作来与软件进行交互。以下是一些常见的无命令交互方式：鼠标、键盘、触屏、语音、手势等等。

一般 PC 客户端主要的还是以鼠标和键盘为主。
- **鼠标事件**：包括点击、双击、右键点击、拖拽、悬停等操作。
- **键盘事件**：除了基本的按键输入外，还包括快捷键、组合键等。

#### 1.1 客户端程序是怎么理解键盘输入的？

当用户在键盘上按下一个键，并在客户端程序中显示相应的字符，这个过程涉及多个步骤，包括硬件层、操作系统层和应用程序层。以下是详细的步骤：

1. **硬件层**：
   - 用户按下键盘上的一个键。
   - 键盘控制器检测到按键事件，并将按键的扫描码发送到计算机。

2. **操作系统层**：
   - 操作系统接收到键盘控制器发送的扫描码。
   - 操作系统将扫描码转换为虚拟键码（Virtual Key Code）。
   - 操作系统生成一个键盘事件（如 `WM_KEYDOWN` 和 `WM_CHAR`），并将其放入消息队列中。

3. **应用程序层**：
   - 应用程序从消息队列中获取键盘事件。
   - 应用程序处理键盘事件，将虚拟键码转换为字符。
   - 应用程序在适当的位置显示字符。

#### 1.2 事件队列的存在形式

事件队列是操作系统用于管理和分发事件的机制。以下是事件队列的存在形式和工作原理：

1. **操作系统的事件队列**：
   - 操作系统维护一个全局的事件队列，用于接收来自硬件设备（如键盘、鼠标等）的事件。
   - 操作系统根据事件的目标窗口，将事件分发到相应应用程序的消息队列中。

2. **应用程序的消息队列**：
   - 每个应用程序都有自己的消息队列，用于接收和处理来自操作系统的事件。
   - 应用程序通过事件循环（Event Loop）不断从消息队列中获取事件，并进行处理。

#### 1.3 图形库的适配和接口提供

图形库（如 Qt、GTK、WinAPI 等）提供了对操作系统事件队列的适配，并提供了方便的接口供开发者使用。以下是图形库如何适配事件队列并提供接口的过程：

1. **事件适配**：
   - 图形库通过操作系统提供的 API 接口，访问操作系统的事件队列。
   - 图形库将操作系统的原始事件转换为库内部的事件对象。

2. **事件循环**：
   - 图形库实现了自己的事件循环，用于从操作系统获取事件，并将其分发到应用程序的各个窗口和控件。
   - 开发者可以通过重写事件处理函数（如 Qt 中的 `keyPressEvent`）来处理特定的事件。

3. **接口提供**：
   - 图形库提供了丰富的事件处理接口，供开发者使用。例如，Qt 提供了 `QKeyEvent` 类和 `keyPressEvent` 函数，用于处理键盘事件。
   - 开发者可以通过这些接口，方便地获取和处理事件，而不需要直接与操作系统的事件队列交互。

#### 1.4 操作系统怎么知道将鼠标和键盘响应给到对应的事件？

- **活动窗口**：操作系统维护一个活动窗口（Active Window）的概念，表示用户当前正在与之交互的窗口。通常，只有活动窗口会接收键盘输入。
- **焦点窗口**：焦点窗口（Focus Window）是当前接收键盘输入的窗口。通常，活动窗口也是焦点窗口，但在某些情况下（如嵌套窗口或对话框），焦点窗口可能是活动窗口的子窗口。

1. **鼠标事件**：
   - 当用户移动鼠标或点击鼠标按钮时，鼠标事件会被生成。
   - 操作系统根据鼠标指针的位置确定目标窗口，并将鼠标事件分发给该窗口。
   - 如果鼠标指针位于某个窗口的区域内，该窗口将接收到鼠标事件。

2. **键盘事件**：
   - 当用户按下键盘上的一个键时，键盘事件会被生成。
   - 操作系统将键盘事件分发给当前的焦点窗口。
   - 焦点窗口通常是用户最后点击或激活的窗口。

#### 1.5 全局热键的实现原理是什么？

全局热键（Global Hotkey）是一种特殊的键盘快捷键，可以在任何应用程序中触发特定的操作。全局热键的实现通常涉及操作系统级别的钩子（Hook）机制。

钩子是一种允许应用程序监视系统消息的机制。通过设置钩子，应用程序可以拦截和处理特定类型的系统消息。

1. **设置全局钩子**：
   - 应用程序可以使用操作系统提供的 API 设置全局钩子，以监视键盘事件。
   - 在 Windows 中，可以使用 `SetWindowsHookEx` 函数设置键盘钩子。

2. **处理钩子事件**：
   - 当键盘事件发生时，钩子函数会被调用。
   - 钩子函数可以检查按键组合是否匹配预定义的全局热键。
   - 如果匹配，钩子函数可以执行相应的操作，并选择是否继续将事件传递给其他应用程序。

#### 1.99 总结

当鼠标和键盘产生输入的时候，操作系统首先会通过硬件驱动解析这些输入，得到鼠标位置或键盘按键等信息。然后将这些信息转换为标准化的事件消息，并放入操作系统的全局事件队列中。操作系统根据当前活动窗口和焦点窗口，将这些事件消息分发到相应的客户端程序。一般客户端程序也有自己的事件队列，用于维护从操作系统和其他进程传入的事件。客户端程序通过事件循环不断从事件队列中获取事件，并调用相应的事件处理函数进行处理。

也就是有这四大步骤：

1. **硬件驱动解析输入**：
   - 硬件驱动程序负责将硬件输入（如扫描码、位置数据）转换为操作系统可以理解的格式。

2. **标准化事件消息**：
   - 操作系统将硬件输入转换为标准化的事件消息，例如键盘事件 `WM_KEYDOWN`、鼠标事件 `WM_MOUSEMOVE` 等。

3. **全局事件队列**：
   - 操作系统维护一个全局事件队列，用于存储所有输入事件和系统事件。
   - 操作系统根据当前活动窗口和焦点窗口，将事件消息分发到相应的客户端程序。

4. **客户端程序的事件队列和事件循环**：
   - 每个客户端程序都有自己的事件队列，用于接收和处理来自操作系统的事件消息。
   - 客户端程序通过事件循环不断从事件队列中获取事件，并调用相应的事件处理函数进行处理。

这些客户端的原生接口一般都是通过 C 语言接口暴露的，因为接口太过底层，使用起来相对复杂。因此，一般都是基于封装的库去操作这些事件队列，如 Qt、GTK、WinAPI 等图形库。

另外，这一个事件队列不等同于进程通信的事件队列。这个是 GUI 事件队列，进程通信的是 IPC 消息队列。这两个队列是独立的。

### 2. 命令交互
命令交互（Command Interaction）是一种用户与计算机系统或软件应用程序进行交互的方式，其中用户通过输入命令来执行特定的操作或功能。命令交互通常用于命令行界面（CLI）或图形用户界面（GUI）中的某些高级功能。

一般来说客户端每一个按键都会绑定一个命令，如果是命令行程序，
* 命令的事务功能怎么实现的？
* 命令一般需要提供哪些时机？
* 长命令怎么处理？分阶段命令怎么处理？


### 3. io事件处理
* 鼠标是如何处理的？
* 选择集是如何处理的？
* 快捷键，组合键是怎么处理的？

### 4. 